version: '3.4'
services:

  nginx-proxy:
    image: jwilder/nginx-proxy
    container_name: nginx
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - '/var/run/docker.sock:/tmp/docker.sock:ro'
      - './private/shared/nginx/vhost.d:/etc/nginx/vhost.d'
      - './private/shared/nginx/certs:/etc/nginx/certs:ro'
    networks:
      proxy: null
      identityserverui:
        aliases:
          - sts.identity-server.local
          - admin.identity-server.local
          - admin-api.identity-server.local
    restart: always


  db:
    image: 'mcr.microsoft.com/mssql/server:2017-CU20-ubuntu-16.04'
    ports:
      - '7900:1433'
    container_name: skoruba-identityserver4-db
    volumes:
      - ./private/mydata/db/data:/var/opt/mssql/data
      - ./private/mydata/db/log:/var/opt/mssql/log
      - ./private/mydata/db/backup:/var/opt/mssql/backup
    env_file:
      - ./private/docker/db.env
    networks:
      identityserverui: null


  skoruba.identityserver4.admin:
    image: 'registry.gitlab.com/magus-devlabs/identityserver4/admin'
    build:
      context: .
      dockerfile: src/Skoruba.IdentityServer4.Admin/Dockerfile
    container_name: skoruba-identityserver4-admin
    env_file:
      - ./private/docker/admin.env
    command: dotnet Skoruba.IdentityServer4.Admin.dll /seed
    depends_on:
      - db
      - skoruba.identityserver4.sts.identity
    volumes:
      - './private/mydata/admin/log:/app/log'
      - './private/shared/serilog.json:/app/serilog.json'
      - './private/shared/identitydata.json:/app/identitydata.json'
      - './private/shared/identityserverdata.json:/app/identityserverdata.json'
      - './private/shared/nginx/certs/cacerts.crt:/usr/local/share/ca-certificates/cacerts.crt'
    networks:
      identityserverui: null


  skoruba.identityserver4.admin.api:
    image: 'registry.gitlab.com/magus-devlabs/identityserver4/admin-api'
    build:
      context: .
      dockerfile: src/Skoruba.IdentityServer4.Admin.Api/Dockerfile
    container_name: skoruba-identityserver4-admin-api
    env_file:
      - ./private/docker/admin-api.env
    volumes:
      - './private/mydata/admin-api/log:/app/log'
      - './private/shared/serilog.json:/app/serilog.json'
      - './private/shared/nginx/certs/cacerts.crt:/usr/local/share/ca-certificates/cacerts.crt'
    networks:
      identityserverui: null


  skoruba.identityserver4.sts.identity:
    image: 'registry.gitlab.com/magus-devlabs/identityserver4/sts-identity'
    build:
      context: .
      dockerfile: src/Skoruba.IdentityServer4.STS.Identity/Dockerfile
    container_name: skoruba-identityserver4-sts-identity
    env_file:
      - ./private/docker/sts-identity.env
    depends_on:
      - db
    volumes:
      - './private/mydata/sts/log:/app/log'
      - './private/shared/serilog.json:/app/serilog.json'
      - './private/shared/nginx/certs/cacerts.crt:/usr/local/share/ca-certificates/cacerts.crt'
    networks:
      identityserverui:
        aliases:
          - sts.identity-server.local

networks:
  proxy:
    driver: bridge
  identityserverui:
    driver: bridge
